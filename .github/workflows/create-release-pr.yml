# Create Release PR workflow using releaseo
#
# This workflow automates release PR creation by:
# 1. Bumping the version (major/minor/patch)
# 2. Updating VERSION, Chart.yaml, and values.yaml
# 3. Creating a PR via GitHub API
#
# Usage: Trigger manually from Actions tab or via `gh workflow run create-release-pr.yml`

name: Create Release PR

on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: write
  pull-requests: write

jobs:
  release:
    name: Create Release PR
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - uses: actions/setup-go@4b73464bb391d4059bd26b0524d20df3927bd417 # v6
        with:
          go-version-file: 'go.mod'

      - name: Setup helm-docs
        run: go install github.com/norwoodj/helm-docs/cmd/helm-docs@latest

      - name: Create Release PR
        id: release
        uses: stacklok/releaseo@b7022753f832cac36a9e07769a679a7c1ca72fe2 # v0.0.3
        with:
          releaseo_version: v0.0.1
          bump_type: ${{ inputs.bump_type }}
          token: ${{ secrets.RELEASE_TOKEN }}
          version_files: |
            - file: deploy/charts/toolhive-registry-server/Chart.yaml
              path: version
            - file: deploy/charts/toolhive-registry-server/Chart.yaml
              path: appVersion
            - file: deploy/charts/toolhive-registry-server/values.yaml
              path: image.registryServerUrl
              prefix: v
          helm_docs_args: --chart-search-root=deploy/charts

      - name: Summary
        run: |
          echo "## Release PR Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.release.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **PR**: #${{ steps.release.outputs.pr_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: ${{ steps.release.outputs.pr_url }}" >> $GITHUB_STEP_SUMMARY
