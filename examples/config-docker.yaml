# Docker Compose configuration for ToolHive Registry API
#
# This configuration is designed for use with docker-compose.yaml in the repository root.
# It demonstrates database-backed registry with PostgreSQL.
#
# Prerequisites:
#   - Docker and Docker Compose installed
#   - THV_DATABASE_PASSWORD environment variable set in docker-compose.yaml
#
# Usage:
#   docker-compose up
#
# The docker-compose setup includes:
#   1. postgres - PostgreSQL 18 database server
#   2. registry-api - Main API server (runs migrations automatically on startup)
#
# Database password is provided via THV_DATABASE_PASSWORD environment variable
# set in the docker-compose.yaml file for the registry-api service.

# Registry name/identifier
registryName: docker-registry

# Registries configuration (can have multiple registries)
registries:
  - name: local-file
    # Data format: toolhive (native) or upstream (MCP registry format)
    format: upstream

    # Local file configuration
    # Use file source for docker-compose demo
    # The sample registry file is mounted at /registry-sample.json
    file:
      path: /registry-sample.json

    # Per-registry automatic synchronization policy
    syncPolicy:
      # Check for file changes every 5 minutes
      interval: "5m"

# PostgreSQL database configuration with separate users for migrations and operations
# This demonstrates the principle of least privilege:
#   - Migration user (db_migrator) has elevated privileges for schema changes
#   - Application user (db_app) has limited privileges for normal operations
database:
  # Use service name from docker-compose as hostname
  host: postgres

  # PostgreSQL default port
  port: 5432

  # Application user with limited privileges (SELECT, INSERT, UPDATE, DELETE)
  # Password from THV_DATABASE_PASSWORD environment variable
  user: db_app

  # Migration user with elevated privileges (CREATE, ALTER, DROP)
  # Password from THV_DATABASE_MIGRATION_PASSWORD environment variable
  migrationUser: db_migrator

  # Passwords are read from environment variables (set in docker-compose.yaml):
  # - THV_DATABASE_PASSWORD: Application user password
  # - THV_DATABASE_MIGRATION_PASSWORD: Migration user password

  # Database name (must match POSTGRES_DB in docker-compose.yaml)
  database: registry

  # Disable SSL for local Docker network (NOT for production!)
  sslMode: disable

  # Connection pool settings optimized for local development
  maxOpenConns: 10
  maxIdleConns: 2
  connMaxLifetime: "30m"
