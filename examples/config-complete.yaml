# Complete configuration example showing all available options
#
# This is a comprehensive reference showing every supported configuration option
# with multi-registry support. Most deployments will only need a subset of these settings.
#
# For practical examples, see:
#   - config-git.yaml: Git repository source
#   - config-api.yaml: API endpoint source
#   - config-file.yaml: Local file source

# ==============================================================================
# REGISTRY IDENTIFICATION (Optional)
# ==============================================================================

# Registry name/identifier
# This name is used for:
#   - Identifying this registry instance in logs
#   - Naming Kubernetes resources (if deployed)
#   - API responses and metadata
# Defaults to "default" if not specified
registryName: my-registry

# ==============================================================================
# REGISTRIES CONFIGURATION (Required)
# ==============================================================================

# Registries configuration allows you to sync from multiple sources simultaneously
# Each registry has its own name, sync policy, filters, and source configuration

registries:
  # ------------------------------------------------------------------------------
  # FIRST REGISTRY: Git Source (ToolHive Format)
  # ------------------------------------------------------------------------------
  - name: toolhive
    # Data format: toolhive (native) or upstream (MCP registry format)
    format: toolhive

    # Git repository configuration
    git:
      # Repository URL (Required for git source)
      # Supports HTTP, HTTPS, and SSH protocols
      repository: https://github.com/stacklok/toolhive.git

      # Version selection (Choose ONE of: branch, tag, or commit)
      # Option 1: Use a branch (tracks latest commits)
      branch: main

      # Option 2: Use a specific tag (pinned version)
      # tag: v1.0.0

      # Option 3: Use a specific commit SHA (exact version)
      # commit: abc123def456789

      # Path to registry file within repository (Required)
      path: pkg/registry/data/registry.json

    # Per-registry synchronization policy
    syncPolicy:
      # Sync interval - how often to check for and sync updates
      # Format: Go duration string (e.g., "30s", "5m", "1h", "24h")
      # Recommended: 30m-1h for Git sources
      interval: "30m"

    # Per-registry filter configuration (optional)
    filter:
      # Name-based filtering
      names:
        # Only include official and stacklok servers
        include:
          - "official/*"
          - "stacklok/*"
        # Exclude deprecated servers
        exclude:
          - "*/deprecated"

      # Tag-based filtering
      tags:
        # Only include stable servers
        include:
          - "stable"
          - "production"
        # Exclude experimental servers
        exclude:
          - "experimental"
          - "beta"

  # ------------------------------------------------------------------------------
  # SECOND REGISTRY: API Source (Upstream MCP Format)
  # ------------------------------------------------------------------------------
  - name: mcp-upstream
    # Data format: upstream is required for API sources
    format: upstream

    # API endpoint configuration
    api:
      # Base API URL without path (Required)
      # The sync manager appends standard MCP registry API v0.1 paths:
      #   - /v0.1/servers (list all servers with pagination)
      #   - /v0.1/servers/{name}/versions (list server versions)
      #   - /v0.1/servers/{name}/versions/{version} (get specific version)

      endpoint: https://registry.modelcontextprotocol.io/

    # Per-registry synchronization policy
    syncPolicy:
      # Sync interval - less frequent for upstream API to be respectful
      # Recommended: 1h-6h for API sources
      interval: "1h"

    # Per-registry filter configuration (optional for this registry)
    filter:
      # Name-based filtering
      names:
        # Only include verified MCP servers
        include:
          - "@modelcontextprotocol/*"

      # Tag-based filtering
      tags:
        # Only include official servers
        include:
          - "official"
          - "verified"

  # ------------------------------------------------------------------------------
  # THIRD REGISTRY: File Source (Local Testing)
  # ------------------------------------------------------------------------------
  # Uncomment to add a local file registry for testing
  # - name: local-test
  #   format: toolhive
  #
  #   # Local file configuration
  #   file:
  #     # Path to registry.json file (absolute or relative)
  #     # Useful for:
  #     #   - Reading from mounted volumes (e.g., ConfigMaps as files)
  #     #   - Pre-downloaded or static registry data
  #     #   - Development and testing
  #     path: ./data/registry.json
  #
  #   # Per-registry synchronization policy
  #   syncPolicy:
  #     # Sync interval - shorter for local files
  #     # Recommended: 1m-5m for file sources
  #     interval: "5m"
  #
  #   # Per-registry filter configuration (optional)
  #   filter:
  #     # Name-based filtering
  #     names:
  #       include:
  #         - "test/*"
  #     # Tag-based filtering
  #     tags:
  #       include:
  #         - "development"

# ==============================================================================
# DATABASE CONFIGURATION (Optional)
# ==============================================================================

# PostgreSQL database configuration
# When configured, the application will store synced registry data in the database
# instead of local JSON files. This enables:
#   - Centralized data storage for multiple instances
#   - Better performance for large registries
#   - SQL query capabilities
#   - Transactional updates

auth:
  mode: anonymous

database:
  # Database server hostname or IP address (Required)
  host: localhost

  # Database server port (Required)
  port: 5432

  # Application database username (Required)
  # This user has limited privileges: SELECT, INSERT, UPDATE, DELETE
  user: thv_user

  # Migration database username (Optional)
  # This user has elevated privileges: CREATE, ALTER, DROP
  # Used for running schema migrations on startup
  # If not set, defaults to the regular 'user' for backward compatibility
  migrationUser: thv_migrator

  # Database name (Required)
  database: toolhive_registry

  # Password management via pgpass file (Recommended)
  # The pgpass file provides credentials for both application and migration users
  # Format: hostname:port:database:username:password
  # Example ~/.pgpass contents:
  #   localhost:5432:toolhive_registry:thv_user:app_password
  #   localhost:5432:toolhive_registry:thv_migrator:migration_password
  # Set PGPASSFILE environment variable to use a custom location
  # See: https://www.postgresql.org/docs/current/libpq-pgpass.html

  # SSL mode (Optional, defaults to "require")
  # Options: disable, require, verify-ca, verify-full
  # Production should use "verify-full" for maximum security
  sslMode: require

  # Connection pool settings (Optional)
  # Maximum number of open connections to the database
  maxOpenConns: 25

  # Maximum number of idle connections in the pool
  maxIdleConns: 5

  # Maximum lifetime of a connection (e.g., "1h", "30m")
  # Helps with database connection rotation and load balancing
  connMaxLifetime: "1h"

# ==============================================================================
# NOTES
# ==============================================================================

# Storage Locations:
#   Without database:
#     - Registry data: ./data/{registryName}/registry.json (per-registry)
#     - Sync status: ./data/{registryName}/status.json (per-registry)
#   With database:
#     - Registry data: PostgreSQL database
#     - Sync status: PostgreSQL database

# Multi-Registry Behavior:
#   - Each registry runs in its own sync loop with independent timing
#   - API responses merge servers from all configured registries
#   - Per-registry filters are applied before merging
#   - Storage is isolated per registry for better organization

# Authentication:
#   - File: No authentication required
#   - Git: Uses default git credential helper (SSH keys, .netrc, etc.)
#   - API: Currently no authentication (will be added in future)
#   - Database: Uses PostgreSQL's pgpass file for password management

# Error Handling:
#   - Failed syncs are retried at the next configured sync interval
#   - Each registry's sync interval is configured independently
#   - Server continues running even if one registry sync fails
#   - Per-registry status is persisted to track failures and attempts

# Filter Behavior:
#   - Filters are applied per-registry before merging
#   - Order: name include → name exclude → tag include → tag exclude
#   - Empty include list means "include all"
#   - Empty exclude list means "exclude none"
#   - Patterns use glob syntax: * (any chars), ? (single char)
#   - Tag matching is exact (no glob patterns)

# Performance:
#   - Each registry sync runs in a separate goroutine
#   - Registry data is cached in memory (refreshes based on sync interval)
#   - Sync status is written atomically per registry to prevent corruption
#   - Git clones are shallow (depth=1) to minimize bandwidth

# Monitoring:
#   - Check ./data/{registryName}/status.json for per-registry sync health
#   - Watch server logs for sync messages with registry names

#   - Monitor serverCount in status for changes per registry
