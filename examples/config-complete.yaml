# Complete configuration example showing all available options
#
# This is a comprehensive reference showing every supported configuration option.
# Most deployments will only need a subset of these settings.
#
# For practical examples, see:
#   - config-git.yaml: Git repository source
#   - config-api.yaml: API endpoint source
#   - config-file.yaml: Local file source

# ==============================================================================
# REGISTRY IDENTIFICATION (Optional)
# ==============================================================================

# Registry name/identifier
# This name is used for:
#   - Identifying this registry instance in logs
#   - Naming Kubernetes resources (if deployed)
#   - API responses and metadata
# Defaults to "default" if not specified
registryName: my-registry

# ==============================================================================
# DATA SOURCE CONFIGURATION (Required)
# ==============================================================================

source:
  # Source type (Required)
  # Options: git, api, file
  type: git

  # Data format (Required)
  # Options:
  #   - toolhive: Native ToolHive registry format (recommended)
  #   - upstream: Official MCP registry format (not yet fully supported)
  format: toolhive

  # ------------------------------------------------------------------------------
  # GIT SOURCE OPTIONS (used when type: git)
  # ------------------------------------------------------------------------------
  git:
    # Repository URL (Required for git source)
    # Supports HTTP, HTTPS, and SSH protocols
    repository: https://github.com/stacklok/toolhive.git

    # Version selection (Choose ONE of: branch, tag, or commit)

    # Option 1: Use a branch (tracks latest commits)
    branch: main

    # Option 2: Use a specific tag (pinned version)
    # tag: v1.0.0

    # Option 3: Use a specific commit SHA (exact version)
    # commit: abc123def456789

    # Path to registry file within repository (Required)
    path: pkg/registry/data/registry.json

  # ------------------------------------------------------------------------------
  # API ENDPOINT SOURCE OPTIONS (used when type: api)
  # ------------------------------------------------------------------------------
  # api:
  #   # Base API URL without path (Required)
  #   # The sync manager appends standard MCP registry API paths:
  #   #   - /v0/servers (list all servers)
  #   #   - /v0/servers/{name} (get specific server, future)
  #   #   - /v0/info (registry metadata, future)
  #   endpoint: https://registry.modelcontextprotocol.io/api

  # ------------------------------------------------------------------------------
  # LOCAL FILE SOURCE OPTIONS (used when type: file)
  # ------------------------------------------------------------------------------
  # file:
  #   # Path to registry.json file (Required)
  #   # Can be absolute or relative to the working directory
  #   # Useful for:
  #   #   - Reading from mounted volumes (e.g., ConfigMaps as files)
  #   #   - Pre-downloaded or static registry data
  #   #   - Development and testing
  #   path: ./data/registry.json

# ==============================================================================
# SYNCHRONIZATION POLICY (Required)
# ==============================================================================

syncPolicy:
  # Sync interval (Required)
  # How often to check for and sync updates from the source
  # Format: Go duration string (e.g., "30s", "5m", "1h", "24h")
  #
  # Recommended values:
  #   - File: 1m-5m (local source, low latency)
  #   - Git: 30m-1h (balance freshness vs. load)
  #   - API: 1h-6h (respectful of external services)
  #   - Stable: 24h (infrequent updates)
  interval: "30m"

# ==============================================================================
# FILTERING CONFIGURATION (Optional)
# ==============================================================================

# Filter configuration allows you to include/exclude servers from the synced registry
# This is useful for:
#   - Creating curated subsets of larger registries
#   - Removing deprecated or internal-only servers
#   - Enforcing organizational policies
#   - Reducing registry size for specific use cases

filter:
  # ------------------------------------------------------------------------------
  # NAME-BASED FILTERING (Optional)
  # ------------------------------------------------------------------------------
  names:
    # Include patterns (Optional)
    # Only servers matching these glob patterns will be included
    # Patterns are evaluated before exclude patterns
    include:
      - "official/*"          # Include all official servers
      - "stacklok/*"          # Include all Stacklok servers
      - "@modelcontextprotocol/*"  # Include all MCP organization servers

    # Exclude patterns (Optional)
    # Servers matching these patterns will be removed
    # Applied after include patterns
    exclude:
      - "*/deprecated"        # Exclude deprecated servers
      - "*/internal"          # Exclude internal-only servers
      - "*/test"              # Exclude test servers
      - "experimental/*"      # Exclude experimental namespace

  # ------------------------------------------------------------------------------
  # TAG-BASED FILTERING (Optional)
  # ------------------------------------------------------------------------------
  tags:
    # Include tags (Optional)
    # Only servers with at least one of these tags will be included
    include:
      - "production"          # Only production-ready servers
      - "stable"              # Only stable releases
      - "verified"            # Only verified servers
      - "certified"           # Only certified servers

    # Exclude tags (Optional)
    # Servers with any of these tags will be removed
    # Applied after include tags
    exclude:
      - "experimental"        # Exclude experimental servers
      - "beta"                # Exclude beta versions
      - "alpha"               # Exclude alpha versions
      - "deprecated"          # Exclude deprecated servers
      - "unmaintained"        # Exclude unmaintained servers

# ==============================================================================
# DATABASE CONFIGURATION
# ==============================================================================

# PostgreSQL database configuration
# When storage is set to "database", this configuration is REQUIRED
# Database storage enables:
#   - Centralized data storage for multiple instances
#   - Better performance for large registries
#   - SQL query capabilities
#   - Transactional updates

database:
  # Database server hostname or IP address (Required)
  host: localhost

  # Database server port (Required)
  port: 5432

  # Database username (Required)
  user: thv_user

  # Password file path (Recommended for production)
  # The file should contain only the password (trailing whitespace is trimmed)
  # This is more secure than environment variables or inline passwords
  passwordFile: /run/secrets/db_password

  # Alternative: Use THV_DATABASE_PASSWORD environment variable
  # If passwordFile is not set, the application will check this env var
  # export THV_DATABASE_PASSWORD="your-password-here"

  # Database name (Required)
  database: toolhive_registry

  # SSL mode (Optional, defaults to "require")
  # Options: disable, require, verify-ca, verify-full
  # Production should use "verify-full" for maximum security
  sslMode: require

  # Connection pool settings (Optional)
  # Maximum number of open connections to the database
  maxOpenConns: 25

  # Maximum number of idle connections in the pool
  maxIdleConns: 5

  # Maximum lifetime of a connection (e.g., "1h", "30m")
  # Helps with database connection rotation and load balancing
  connMaxLifetime: "1h"

# ==============================================================================
# NOTES
# ==============================================================================

# Storage Locations:
#   Without database:
#     - Registry data: ./data/registry.json
#     - Sync status: ./data/status.json
#   With database:
#     - Registry data: PostgreSQL database
#     - Sync status: PostgreSQL database
#
# The storage location is currently hardcoded but will be configurable
# via CLI flags in a future release.

# Authentication:
#   - File: No authentication required
#   - Git: Uses default git credential helper (SSH keys, .netrc, etc.)
#   - API: Currently no authentication (will be added in future)
#   - Database: Uses passwordFile (recommended) or THV_DATABASE_PASSWORD env var

# Error Handling:
#   - Failed syncs are retried at the next configured sync interval
#   - Sync interval is configured via syncPolicy.interval (e.g., "5m", "30m", "1h")
#   - Server continues running even if sync fails
#   - Status is persisted to track failures and attempts

# Filter Behavior:
#   - Filters are applied in order: name include → name exclude → tag include → tag exclude
#   - Empty include list means "include all"
#   - Empty exclude list means "exclude none"
#   - Patterns use glob syntax: * (any chars), ? (single char)
#   - Tag matching is exact (no glob patterns)

# Performance:
#   - Sync runs in background, doesn't block server startup
#   - Registry data is cached in memory (refreshes every 30s by default)
#   - Sync status is written atomically to prevent corruption
#   - Git clones are shallow (depth=1) to minimize bandwidth

# Monitoring:
#   - Check ./data/status.json for sync health
#   - Watch server logs for sync messages
#   - Use GET /api/v0/info endpoint for registry metadata
#   - Monitor serverCount in status for changes
