# Default values for toolhive-registry-server.
# This is a YAML-formatted file.

# -- Number of replicas
replicaCount: 1

image:
  # -- URL of the registry server image
  registryServerUrl: "ghcr.io/stacklok/thv-registry-api:v0.6.0"

  # -- Image pull policy
  pullPolicy: IfNotPresent

# -- Image pull secrets for private registries
imagePullSecrets: []
# -- Override the name of the chart
nameOverride: ""
# -- Override the full name of the chart
fullnameOverride: ""

serviceAccount:
  # -- Specifies whether a service account should be created
  create: true
  # -- Annotations to add to the service account
  annotations: {}
  # -- The name of the service account to use
  name: "toolhive-registry-server"

# -- Annotations to add to the pod
podAnnotations: {}

# -- Labels to add to the pod
podLabels: {}

# -- Pod security context
podSecurityContext: {}
  # fsGroup: 2000

# -- Container security context
securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: true
  runAsNonRoot: true
  runAsUser: 65535
  seccompProfile:
    type: RuntimeDefault

service:
  # -- Service type
  type: ClusterIP
  # -- Service port
  port: 8080
  # -- Service annotations
  annotations: {}

# -- Resource requests and limits (matching operator defaults)
resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 100m
    memory: 128Mi

# -- Liveness probe configuration
livenessProbe:
  httpGet:
    path: /health
    port: http
  initialDelaySeconds: 30
  periodSeconds: 10

# -- Readiness probe configuration
readinessProbe:
  httpGet:
    path: /readiness
    port: http
  initialDelaySeconds: 5
  periodSeconds: 5

# -- Node selector for pod scheduling
nodeSelector: {}

# -- Tolerations for pod scheduling
tolerations: []

# -- Affinity rules for pod scheduling
affinity: {}

# -- Init containers to run before the main container
# Use this for setup tasks like preparing pgpass files, waiting for dependencies, etc.
# Init containers share the same volumes as the main container (extraVolumes)
initContainers: []
  # Example: pgpass init container for PostgreSQL authentication
  # - name: pgpass-init
  #   image: cgr.dev/chainguard/busybox:latest
  #   command:
  #     - sh
  #     - -c
  #     - |
  #       cp /pgpass-secret/.pgpass /pgpass-prepared/.pgpass
  #       chmod 600 /pgpass-prepared/.pgpass
  #   securityContext:
  #     allowPrivilegeEscalation: false
  #     capabilities:
  #       drop:
  #         - ALL
  #     readOnlyRootFilesystem: true
  #     runAsNonRoot: true
  #     runAsUser: 65535
  #   volumeMounts:
  #     - name: pgpass-secret
  #       mountPath: /pgpass-secret
  #       readOnly: true
  #     - name: pgpass-prepared
  #       mountPath: /pgpass-prepared

# ==============================================================================
# Registry Server Configuration
# ==============================================================================
# This section is rendered directly as the config.yaml file for the registry server.
# Any valid registry server configuration can be added here.
# See: https://github.com/stacklok/toolhive-registry-server/blob/main/docs/configuration.md
#
# The entire config block is rendered as YAML into the ConfigMap, so you can add
# any new fields without modifying the chart templates.

config:
  # Registry name/identifier for this instance
  registryName: "default"

  # Registry sources configuration - at least one registry must be configured
  registries:
    - name: toolhive
      format: toolhive
      git:
        repository: https://github.com/stacklok/toolhive.git
        branch: main
        path: pkg/registry/data/registry.json
      syncPolicy:
        interval: "30m"

  # Authentication configuration
  auth:
    mode: anonymous

  # PostgreSQL database configuration (required)
  # Passwords are managed via PostgreSQL's pgpass file (~/.pgpass or $PGPASSFILE)
  # See: https://www.postgresql.org/docs/current/libpq-pgpass.html
  database:
    host: localhost
    port: 5432
    user: thv_user
    database: toolhive_registry
    sslMode: require

# Example database configuration (uncomment and customize):
# config:
#   registryName: "production"
#   registries:
#     - name: toolhive
#       format: toolhive
#       git:
#         repository: https://github.com/stacklok/toolhive.git
#         tag: v1.0.0
#         path: pkg/registry/data/registry.json
#       syncPolicy:
#         interval: "1h"
#   database:
#     host: postgres.example.com
#     port: 5432
#     user: registry_user
#     migrationUser: registry_migrator
#     database: toolhive_registry
#     sslMode: verify-full
#     maxOpenConns: 25
#     maxIdleConns: 5
#     connMaxLifetime: "1h"
#   auth:
#     mode: oauth
#     oauth:
#       realm: "mcp-registry"
#       scopesSupported:
#         - "mcp-registry:read"
#         - "mcp-registry:write"
#       providers:
#         - name: keycloak
#           issuerUrl: https://auth.example.com/realms/myrealm
#           audience: toolhive-registry

# ==============================================================================
# Additional Environment Variables
# ==============================================================================

# -- Additional environment variables to add to the container
# Use this for secrets, feature flags, or runtime configuration
extraEnv: []
  # - name: THV_REGISTRY_DATABASE_HOST
  #   value: "postgres.example.com"
  # - name: PGPASSFILE
  #   value: "/secrets/pgpass"
  # - name: THV_REGISTRY_INSECURE_URL
  #   value: "true"

# -- Additional environment variables from ConfigMap or Secret references
extraEnvFrom: []
  # - configMapRef:
  #     name: my-config
  # - secretRef:
  #     name: my-secret

# ==============================================================================
# Additional Volume Mounts
# ==============================================================================

# -- Additional volumes to add to the pod
extraVolumes: []
  # - name: pgpass
  #   secret:
  #     secretName: postgres-pgpass
  #     defaultMode: 0600
  # - name: ca-certs
  #   configMap:
  #     name: ca-certificates
  # - name: registry-data
  #   persistentVolumeClaim:
  #     claimName: registry-data-pvc

# -- Additional volume mounts to add to the container
extraVolumeMounts: []
  # - name: pgpass
  #   mountPath: /secrets/pgpass
  #   subPath: pgpass
  #   readOnly: true
  # - name: ca-certs
  #   mountPath: /etc/ssl/certs
  #   readOnly: true
  # - name: registry-data
  #   mountPath: /data

# ==============================================================================
# RBAC Configuration
# ==============================================================================

# -- RBAC configuration for the registry server
rbac:
  # -- Scope of the RBAC configuration.
  # - cluster: The registry server will have cluster-wide permissions via ClusterRole and ClusterRoleBinding.
  # - namespace: The registry server will have permissions to watch resources in the namespaces specified in `allowedNamespaces`.
  #   The registry server will have a ClusterRole and RoleBinding for each namespace in `allowedNamespaces`.
  scope: cluster

  # -- List of namespaces that the registry server is allowed to watch.
  # Only used if scope is set to "namespace".
  allowedNamespaces: []
